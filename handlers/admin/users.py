from aiogram import F
from aiogram.types import Message, CallbackQuery, InlineKeyboardMarkup, InlineKeyboardButton
from aiogram.fsm.context import FSMContext
from database.admin_queries import (
    get_user_management_stats, search_users_by_criteria, update_user_role,
    block_unblock_user, get_system_logs, log_admin_action
)
from database.base_queries import get_user_by_telegram_id, get_user_lang
from keyboards.admin_buttons import get_user_management_keyboard, roles_keyboard, search_user_method_keyboard, get_admin_main_menu
from states.admin_states import AdminUserStates, AdminMainMenuStates
from utils.inline_cleanup import cleanup_user_inline_messages, answer_and_cleanup
from utils.logger import setup_logger
from utils.role_checks import admin_only
from loader import inline_message_manager
from aiogram.filters import StateFilter
from utils.role_router import get_role_router

logger = setup_logger('bot.admin.users')

def get_admin_users_router():
    router = get_role_router("admin")

    @router.message(StateFilter(AdminMainMenuStates.main_menu), F.text.in_(['üë• Foydalanuvchilar', 'üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏']))
    @admin_only
    async def user_management_menu(message: Message, state: FSMContext):
        """User management main menu"""
        try:
            lang = await get_user_lang(message.from_user.id)
            stats = await get_user_management_stats()
            if lang == 'uz':
                text = (
                    f"üë• <b>Foydalanuvchilar boshqaruvi</b>\n\n"
                    f"üìä <b>Statistika:</b>\n"
                )
                for stat in stats:
                    role_name = {
                        'client': 'Mijozlar',
                        'technician': 'Texniklar',
                        'manager': 'Menejerlar',
                        'admin': 'Adminlar',
                        'call_center': 'Call Center',
                        'controller': 'Kontrolyorlar',
                        'warehouse': 'Sklad'
                    }.get(stat['role'], stat['role'])
                    text += f"‚Ä¢ {role_name}: <b>{stat['total']}</b> (faol: <b>{stat['active']}</b>)\n"
                text += f"\nKerakli amalni tanlang:"
            else:
                text = (
                    f"üë• <b>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</b>\n\n"
                    f"üìä <b>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</b>\n"
                )
                for stat in stats:
                    role_name = {
                        'client': '–ö–ª–∏–µ–Ω—Ç—ã',
                        'technician': '–¢–µ—Ö–Ω–∏–∫–∏',
                        'manager': '–ú–µ–Ω–µ–¥–∂–µ—Ä—ã',
                        'admin': '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã',
                        'call_center': '–ö–æ–ª–ª-—Ü–µ–Ω—Ç—Ä',
                        'controller': '–ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã',
                        'warehouse': '–°–∫–ª–∞–¥'
                    }.get(stat['role'], stat['role'])
                    text += f"‚Ä¢ {role_name}: <b>{stat['total']}</b> (–∞–∫—Ç–∏–≤–Ω—ã—Ö: <b>{stat['active']}</b>)\n"
                text += f"\n–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:"
            sent_message = await message.answer(
                text,
                reply_markup=get_user_management_keyboard(lang)
            )
            await inline_message_manager.track(message.from_user.id, sent_message.message_id)
            await state.set_state(AdminUserStates.user_management)
            return sent_message
        except Exception as e:
            logger.error(f"Error in user management menu: {e}", exc_info=True)
            lang = await get_user_lang(message.from_user.id)
            error_text = "Xatolik yuz berdi." if lang == 'uz' else "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞."
            sent_message = await message.answer(error_text)
            await cleanup_user_inline_messages(message.from_user.id)
            return sent_message

    @router.message(F.text.in_(['üîí Bloklash/Blokdan chiqarish', 'üîí –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞/–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞']))
    @admin_only
    async def block_unblock_menu(message: Message, state: FSMContext):
        lang = await get_user_lang(message.from_user.id)
        text = (
            "Foydalanuvchini bloklash yoki blokdan chiqarish uchun qidiruv usulini tanlang:" if lang == 'uz' else
            "–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –ø–æ–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏/—Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏:"
        )
        keyboard = InlineKeyboardMarkup(inline_keyboard=[
            [InlineKeyboardButton(text="üÜî Telegram ID", callback_data="block_search_by_telegram_id")],
            [InlineKeyboardButton(text="üì± Telefon" if lang == 'uz' else "üì± –¢–µ–ª–µ—Ñ–æ–Ω", callback_data="block_search_by_phone")]
        ])
        await message.answer(text, reply_markup=keyboard)
        await state.set_state(AdminUserStates.blocking)

    @router.callback_query(F.data.startswith("block_search_by_"), AdminUserStates.blocking)
    @admin_only
    async def block_search_method_selected(call: CallbackQuery, state: FSMContext):
        lang = await get_user_lang(call.from_user.id)
        search_type = call.data.replace('block_search_by_', '')
        await state.update_data(block_search_type=search_type)
        if search_type == "telegram_id":
            text = "Telegram ID ni kiriting:" if lang == 'uz' else "–í–≤–µ–¥–∏—Ç–µ Telegram ID:"
        elif search_type == "phone":
            text = "Telefon raqamini kiriting:" if lang == 'uz' else "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞:"
        else:
            text = "Noto'g'ri qidiruv turi." if lang == 'uz' else "–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–∏–ø –ø–æ–∏—Å–∫–∞."
        await call.message.edit_text(text)
        await state.set_state(AdminUserStates.blocking)

    @router.message(AdminUserStates.blocking)
    @admin_only
    async def process_block_unblock_id(message: Message, state: FSMContext):
        lang = await get_user_lang(message.from_user.id)
        data = await state.get_data()
        search_type = data.get('block_search_type', 'telegram_id')
        search_value = message.text.strip()
        user = None
        if search_type == 'telegram_id':
            if not search_value.isdigit():
                await message.answer("Telegram ID raqam bo'lishi kerak." if lang == 'uz' else "Telegram ID –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º.")
                return
            user = await get_user_by_telegram_id(int(search_value))
        elif search_type == 'phone':
            user_list = await search_users_by_criteria('phone', search_value)
            user = user_list[0] if user_list else None
        if not user:
            await message.answer("Foydalanuvchi topilmadi." if lang == 'uz' else "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω.")
            return
        # Foydalanuvchi haqida to'liq ma'lumot
        status = "Bloklangan" if not user.get('is_active', True) or user.get('role') == 'blocked' else "Faol"
        text = (
            f"üë§ <b>Foydalanuvchi ma'lumotlari</b>\n\n"
            f"üìù <b>Ism:</b> {user.get('full_name', 'N/A')}\n"
            f"üì± <b>Telefon:</b> {user.get('phone_number', 'N/A')}\n"
            f"üÜî <b>Telegram ID:</b> {user['telegram_id']}\n"
            f"üë§ <b>Joriy rol:</b> {user['role']}\n"
            f"üìÖ <b>Ro'yxatdan o'tgan:</b> {user['created_at'].strftime('%d.%m.%Y %H:%M')}\n"
            f"üîò <b>Holati:</b> {status}\n\n"
        ) if lang == 'uz' else (
            f"üë§ <b>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ</b>\n\n"
            f"üìù <b>–ò–º—è:</b> {user.get('full_name', 'N/A')}\n"
            f"üì± <b>–¢–µ–ª–µ—Ñ–æ–Ω:</b> {user.get('phone_number', 'N/A')}\n"
            f"üÜî <b>Telegram ID:</b> {user['telegram_id']}\n"
            f"üë§ <b>–¢–µ–∫—É—â–∞—è —Ä–æ–ª—å:</b> {user['role']}\n"
            f"üìÖ <b>–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω:</b> {user['created_at'].strftime('%d.%m.%Y %H:%M')}\n"
            f"üîò <b>–°—Ç–∞—Ç—É—Å:</b> {status}\n\n"
        )
        if not user.get('is_active', True) or user.get('role') == 'blocked':
            # Blokdan chiqarish tugmasi
            text += "Foydalanuvchi bloklangan. Blokdan chiqarish uchun tugmani bosing:" if lang == 'uz' else "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω. –î–ª—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ:"
            keyboard = InlineKeyboardMarkup(inline_keyboard=[
                [InlineKeyboardButton(text="üîì Blokdan chiqarish" if lang == 'uz' else "üîì –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å", callback_data=f"unblock_user:{user['telegram_id']}")]
            ])
        else:
            # Bloklash tugmasi
            text += "Foydalanuvchi faol. Bloklash uchun tugmani bosing:" if lang == 'uz' else "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–∫—Ç–∏–≤–µ–Ω. –î–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ:"
            keyboard = InlineKeyboardMarkup(inline_keyboard=[
                [InlineKeyboardButton(text="üîí Bloklash" if lang == 'uz' else "üîí –ë–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å", callback_data=f"block_user:{user['telegram_id']}")]
            ])
        await message.answer(text, reply_markup=keyboard)
        await state.clear()

    @router.callback_query(F.data.startswith("block_user:"))
    @admin_only
    async def block_user(call: CallbackQuery):
        lang = await get_user_lang(call.from_user.id)
        telegram_id = int(call.data.split(":")[-1])
        # Foydalanuvchini bloklash: ro'lini 'blocked' va is_active ni false qilamiz
        success = await update_user_role(telegram_id, 'blocked', call.from_user.id)
        if success:
            await block_unblock_user(telegram_id, 'block', call.from_user.id)
            user = await get_user_by_telegram_id(telegram_id)
            text = (
                f"‚úÖ Foydalanuvchi bloklandi!\n\n" if lang == 'uz' else f"‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω!\n\n"
            )
            text += (
                f"üìù <b>Ism:</b> {user.get('full_name', 'N/A')}\n"
                f"üì± <b>Telefon:</b> {user.get('phone_number', 'N/A')}\n"
                f"üÜî <b>Telegram ID:</b> {user['telegram_id']}\n"
                f"üë§ <b>Joriy rol:</b> {user['role']}\n"
                f"üìÖ <b>Ro'yxatdan o'tgan:</b> {user['created_at'].strftime('%d.%m.%Y %H:%M')}\n"
            ) if lang == 'uz' else (
                f"üìù <b>–ò–º—è:</b> {user.get('full_name', 'N/A')}\n"
                f"üì± <b>–¢–µ–ª–µ—Ñ–æ–Ω:</b> {user.get('phone_number', 'N/A')}\n"
                f"üÜî <b>Telegram ID:</b> {user['telegram_id']}\n"
                f"üë§ <b>–¢–µ–∫—É—â–∞—è —Ä–æ–ª—å:</b> {user['role']}\n"
                f"üìÖ <b>–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω:</b> {user['created_at'].strftime('%d.%m.%Y %H:%M')}\n"
            )
            await call.message.edit_text(text)
            await call.answer("Foydalanuvchi bloklandi!" if lang == 'uz' else "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω!")
        else:
            await call.message.edit_text("Bloklashda xatolik yuz berdi." if lang == 'uz' else "–û—à–∏–±–∫–∞ –ø—Ä–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.")
            await call.answer("Xatolik!" if lang == 'uz' else "–û—à–∏–±–∫–∞!")

    @router.callback_query(F.data.startswith("unblock_user:"))
    @admin_only
    async def unblock_user(call: CallbackQuery):
        lang = await get_user_lang(call.from_user.id)
        telegram_id = int(call.data.split(":")[-1])
        # Foydalanuvchini blokdan chiqarish: ro'lini avvalgi holatga qaytarish (bu yerda qo'lda tanlash yoki logdan olish mumkin, hozircha 'client' qilamiz)
        # TODO: Agar avvalgi ro'lni saqlash kerak bo'lsa, uni alohida logda saqlash va qaytarish kerak
        success = await update_user_role(telegram_id, 'client', call.from_user.id)
        if success:
            await block_unblock_user(telegram_id, 'unblock', call.from_user.id)
            user = await get_user_by_telegram_id(telegram_id)
            text = (
                f"‚úÖ Foydalanuvchi blokdan chiqarildi!\n\n" if lang == 'uz' else f"‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω!\n\n"
            )
            text += (
                f"üìù <b>Ism:</b> {user.get('full_name', 'N/A')}\n"
                f"üì± <b>Telefon:</b> {user.get('phone_number', 'N/A')}\n"
                f"üÜî <b>Telegram ID:</b> {user['telegram_id']}\n"
                f"üë§ <b>Joriy rol:</b> {user['role']}\n"
                f"üìÖ <b>Ro'yxatdan o'tgan:</b> {user['created_at'].strftime('%d.%m.%Y %H:%M')}\n"
            ) if lang == 'uz' else (
                f"üìù <b>–ò–º—è:</b> {user.get('full_name', 'N/A')}\n"
                f"üì± <b>–¢–µ–ª–µ—Ñ–æ–Ω:</b> {user.get('phone_number', 'N/A')}\n"
                f"üÜî <b>Telegram ID:</b> {user['telegram_id']}\n"
                f"üë§ <b>–¢–µ–∫—É—â–∞—è —Ä–æ–ª—å:</b> {user['role']}\n"
                f"üìÖ <b>–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω:</b> {user['created_at'].strftime('%d.%m.%Y %H:%M')}\n"
            )
            await call.message.edit_text(text)
            await call.answer("Foydalanuvchi blokdan chiqarildi!" if lang == 'uz' else "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω!")
        else:
            await call.message.edit_text("Blokdan chiqarishda xatolik yuz berdi." if lang == 'uz' else "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.")
            await call.answer("Xatolik!" if lang == 'uz' else "–û—à–∏–±–∫–∞!")

    @router.message(F.text.in_(["üë• Barcha foydalanuvchilar", "üë• –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏"]))
    @admin_only
    async def list_all_users(message: Message, state: FSMContext):
        """List all users with pagination (first page)"""
        await show_users_page(message, page=1, edit=False)

    @router.callback_query(F.data.startswith("users_page_"))
    @admin_only
    async def users_page_callback(call: CallbackQuery, state: FSMContext):
        """Handle pagination for users list"""
        page = int(call.data.split("_")[-1])
        await show_users_page(call, page=page, edit=True)

    @router.message(F.text.in_(["üë§ Xodimlar", "üë§ –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏"]))
    @admin_only
    async def list_technicians(message: Message, state: FSMContext):
        """List all technicians with pagination (first page)"""
        await show_technicians_page(message, page=1, edit=False)

    @router.callback_query(F.data.startswith("technicians_page_"))
    @admin_only
    async def technicians_page_callback(call: CallbackQuery, state: FSMContext):
        """Handle pagination for technicians list"""
        page = int(call.data.split("_")[-1])
        await show_technicians_page(call, page=page, edit=True)

    async def show_users_page(event, page=1, edit=False):
        lang = await get_user_lang(event.from_user.id)
        # Get all users (all roles)
        users = await search_users_by_criteria('role', 'client')
        users.extend(await search_users_by_criteria('role', 'technician'))
        users.extend(await search_users_by_criteria('role', 'manager'))
        users.extend(await search_users_by_criteria('role', 'admin'))
        users = sorted(users, key=lambda u: u.get('created_at', ''))
        per_page = 10
        total = len(users)
        max_page = (total + per_page - 1) // per_page
        if total == 0:
            text = "Foydalanuvchilar topilmadi." if lang == 'uz' else "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã."
            if edit:
                await event.message.edit_text(text)
            else:
                await event.answer(text)
            return
        start = (page - 1) * per_page
        end = start + per_page
        users_to_show = users[start:end]
        if lang == 'uz':
            text = f"üë• <b>Foydalanuvchilar ro'yxati</b> ({start+1}-{min(end, total)} / {total})\n\n"
        else:
            text = f"üë• <b>–°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</b> ({start+1}-{min(end, total)} / {total})\n\n"
        for i, user in enumerate(users_to_show, start+1):
            role_name = {
                'client': 'Mijoz' if lang == 'uz' else '–ö–ª–∏–µ–Ω—Ç',
                'technician': 'Texnik' if lang == 'uz' else '–¢–µ—Ö–Ω–∏–∫',
                'manager': 'Menejer' if lang == 'uz' else '–ú–µ–Ω–µ–¥–∂–µ—Ä',
                'admin': 'Admin' if lang == 'uz' else '–ê–¥–º–∏–Ω',
                'call_center': 'Call Center',
                'controller': 'Kontrolyor' if lang == 'uz' else '–ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä',
                'warehouse': 'Sklad' if lang == 'uz' else '–°–∫–ª–∞–¥'
            }.get(user['role'], user['role'])
            if lang == 'uz':
                text += (
                    f"{i}. üë§ <b>Ism:</b> {user.get('full_name', 'N/A')}\n"
                    f"   üìû <b>Telefon:</b> {user.get('phone_number', 'N/A')}\n"
                    f"   üÜî <b>Telegram ID:</b> {user['telegram_id']}\n"
                    f"   üè∑Ô∏è <b>Rol:</b> {role_name}\n"
                    f"   üìÖ <b>Ro'yxatdan o'tgan sana:</b> {user['created_at'].strftime('%d.%m.%Y')}\n\n"
                )
            else:
                text += (
                    f"{i}. üë§ <b>–ò–º—è:</b> {user.get('full_name', 'N/A')}\n"
                    f"   üìû <b>–¢–µ–ª–µ—Ñ–æ–Ω:</b> {user.get('phone_number', 'N/A')}\n"
                    f"   üÜî <b>Telegram ID:</b> {user['telegram_id']}\n"
                    f"   üè∑Ô∏è <b>–†–æ–ª—å:</b> {role_name}\n"
                    f"   üìÖ <b>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:</b> {user['created_at'].strftime('%d.%m.%Y')}\n\n"
                )
        # Pagination buttons
        keyboard = []
        if page > 1:
            keyboard.append(InlineKeyboardButton(text="‚¨ÖÔ∏è Oldingi" if lang == 'uz' else "‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data=f"users_page_{page-1}"))
        if page < max_page:
            keyboard.append(InlineKeyboardButton(text="Keyingi ‚û°Ô∏è" if lang == 'uz' else "–î–∞–ª–µ–µ ‚û°Ô∏è", callback_data=f"users_page_{page+1}"))
        markup = InlineKeyboardMarkup(inline_keyboard=[keyboard] if keyboard else [])
        if edit:
            await event.message.edit_text(text, reply_markup=markup)
        else:
            await event.answer(text, reply_markup=markup)

    async def show_technicians_page(event, page=1, edit=False):
        lang = await get_user_lang(event.from_user.id)
        # Xodimlar ro'yxatini olish (technician, manager, controller, warehouse, call_center, admin)
        users = []
        for role in ['technician', 'manager', 'controller', 'warehouse', 'call_center', 'admin']:
            users.extend(await search_users_by_criteria('role', role))
        users = sorted(users, key=lambda u: u.get('created_at', ''))
        per_page = 10
        total = len(users)
        max_page = (total + per_page - 1) // per_page
        if total == 0:
            text = "Xodimlar topilmadi." if lang == 'uz' else "–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã."
            if edit:
                await event.message.edit_text(text)
            else:
                await event.answer(text)
            return
        start = (page - 1) * per_page
        end = start + per_page
        users_to_show = users[start:end]
        if lang == 'uz':
            text = f"üë§ <b>Xodimlar ro'yxati</b> ({start+1}-{min(end, total)} / {total})\n\n"
        else:
            text = f"üë§ <b>–°–ø–∏—Å–æ–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</b> ({start+1}-{min(end, total)} / {total})\n\n"
        for i, user in enumerate(users_to_show, start+1):
            if lang == 'uz':
                # Role names in Uzbek
                role_names = {
                    'technician': 'Texnik',
                    'manager': 'Menejer',
                    'controller': 'Kontrolyor',
                    'warehouse': 'Sklad',
                    'call_center': 'Call Center',
                    'admin': 'Admin'
                }
                role_name = role_names.get(user['role'], user['role'])
                text += (
                    f"{i}. üë§ <b>Ism:</b> {user.get('full_name', 'N/A')}\n"
                    f"   üìû <b>Telefon:</b> {user.get('phone_number', 'N/A')}\n"
                    f"   üÜî <b>Telegram ID:</b> {user['telegram_id']}\n"
                    f"   üè∑Ô∏è <b>Rol:</b> {role_name}\n"
                    f"   üìÖ <b>Ro'yxatdan o'tgan sana:</b> {user['created_at'].strftime('%d.%m.%Y')}\n\n"
                )
            else:
                # Role names in Russian
                role_names = {
                    'technician': '–¢–µ—Ö–Ω–∏–∫',
                    'manager': '–ú–µ–Ω–µ–¥–∂–µ—Ä',
                    'controller': '–ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä',
                    'warehouse': '–°–∫–ª–∞–¥',
                    'call_center': '–ö–æ–ª–ª-—Ü–µ–Ω—Ç—Ä',
                    'admin': '–ê–¥–º–∏–Ω'
                }
                role_name = role_names.get(user['role'], user['role'])
                text += (
                    f"{i}. üë§ <b>–ò–º—è:</b> {user.get('full_name', 'N/A')}\n"
                    f"   üìû <b>–¢–µ–ª–µ—Ñ–æ–Ω:</b> {user.get('phone_number', 'N/A')}\n"
                    f"   üÜî <b>Telegram ID:</b> {user['telegram_id']}\n"
                    f"   üè∑Ô∏è <b>–†–æ–ª—å:</b> {role_name}\n"
                    f"   üìÖ <b>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:</b> {user['created_at'].strftime('%d.%m.%Y')}\n\n"
                )
        # Pagination buttons
        keyboard = []
        if page > 1:
            keyboard.append(InlineKeyboardButton(text="‚¨ÖÔ∏è Oldingi" if lang == 'uz' else "‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data=f"technicians_page_{page-1}"))
        if page < max_page:
            keyboard.append(InlineKeyboardButton(text="Keyingi ‚û°Ô∏è" if lang == 'uz' else "–î–∞–ª–µ–µ ‚û°Ô∏è", callback_data=f"technicians_page_{page+1}"))
        markup = InlineKeyboardMarkup(inline_keyboard=[keyboard] if keyboard else [])
        if edit:
            await event.message.edit_text(text, reply_markup=markup)
        else:
            await event.answer(text, reply_markup=markup)

    @router.message(F.text.in_(["üîç Foydalanuvchi qidirish", "üîç –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"]))
    @admin_only
    async def search_user_menu(message: Message, state: FSMContext):
        """Search user menu"""
        try:
            await cleanup_user_inline_messages(message.from_user.id)
            lang = await get_user_lang(message.from_user.id)
            text = "Qidirish usulini tanlang:" if lang == 'uz' else "–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –ø–æ–∏—Å–∫–∞:"
            await message.answer(
                text,
                reply_markup=search_user_method_keyboard(lang)
            )
            await state.set_state(AdminUserStates.waiting_for_search_method)
        except Exception as e:
            logger.error(f"Error in search user menu: {e}")
            lang = await get_user_lang(message.from_user.id)
            error_text = "Xatolik yuz berdi." if lang == 'uz' else "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞."
            await message.answer(error_text)

    @router.callback_query(F.data.startswith("change_role_"))
    @admin_only
    async def change_user_role(call: CallbackQuery):
        lang = await get_user_lang(call.from_user.id)
        telegram_id = int(call.data.split("_")[-1])
        text = "Yangi rolni tanlang:" if lang == 'uz' else "–í—ã–±–µ—Ä–∏—Ç–µ –Ω–æ–≤—É—é —Ä–æ–ª—å:"
        roles = [
            ("client", "üë§ Mijoz", "üë§ –ö–ª–∏–µ–Ω—Ç"),
            ("technician", "üë®‚Äçüîß Texnik", "üë®‚Äçüîß –¢–µ—Ö–Ω–∏–∫"),
            ("manager", "üë®‚Äçüíº Menejer", "üë®‚Äçüíº –ú–µ–Ω–µ–¥–∂–µ—Ä"),
            ("admin", "üè¢ Admin", "üè¢ –ê–¥–º–∏–Ω"),
            ("call_center", "üìû Call Center", "üìû –ö–æ–ª–ª-—Ü–µ–Ω—Ç—Ä"),
            ("controller", "üéØ Kontrolyor", "üéØ –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä"),
            ("warehouse", "üì¶ Sklad", "üì¶ –°–∫–ª–∞–¥")
        ]
        keyboard = InlineKeyboardMarkup(inline_keyboard=[
            [InlineKeyboardButton(text=uz if lang == 'uz' else ru, callback_data=f"set_role:{role}:{telegram_id}")]
            for role, uz, ru in roles
        ])
        await call.message.edit_text(text, reply_markup=keyboard)

    @router.callback_query(F.data.startswith("set_role:"))
    @admin_only
    async def confirm_role_change(call: CallbackQuery):
        try:
            lang = await get_user_lang(call.from_user.id)
            parts = call.data.split(":")
            new_role = parts[1]
            telegram_id = int(parts[2])
            
            # Get user info
            user = await get_user_by_telegram_id(telegram_id)
            if not user:
                text = "Foydalanuvchi topilmadi." if lang == 'uz' else "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω."
                await call.message.edit_text(text)
                return
                
            # Update user role
            await update_user_role(telegram_id, new_role, call.from_user.id)
            
            # Log the action
            await log_admin_action(
                call.from_user.id,
                "role_change",
                {"user_id": telegram_id, "new_role": new_role, "old_role": user['role']}
            )
            
            success = await update_user_role(telegram_id, new_role, call.from_user.id)
            if success:
                updated_users = await search_users_by_criteria('telegram_id', str(telegram_id))
                updated_user = updated_users[0] if updated_users else user
                text = (
                    f"‚úÖ Rol muvaffaqiyatli o'zgartirildi!\n\n"
                    f"üë§ <b>Foydalanuvchi boshqaruvi</b>\n\n"
                    f"üìù <b>Ism:</b> {updated_user.get('full_name', 'N/A')}\n"
                    f"üì± <b>Telefon:</b> {updated_user.get('phone_number', 'N/A')}\n"
                    f"üÜî <b>Telegram ID:</b> {updated_user['telegram_id']}\n"
                    f"üë§ <b>Joriy rol:</b> {updated_user['role']}\n"
                    f"üìÖ <b>Ro'yxatdan o'tgan:</b> {updated_user['created_at'].strftime('%d.%m.%Y %H:%M')}\n\n"
                    f"Rolni o'zgartirish uchun pastdagi tugmani bosing:"
                ) if lang == 'uz' else (
                    f"‚úÖ –†–æ–ª—å —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω–∞!\n\n"
                    f"üë§ <b>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º</b>\n\n"
                    f"üìù <b>–ò–º—è:</b> {updated_user.get('full_name', 'N/A')}\n"
                    f"üì± <b>–¢–µ–ª–µ—Ñ–æ–Ω:</b> {updated_user.get('phone_number', 'N/A')}\n"
                    f"üÜî <b>Telegram ID:</b> {updated_user['telegram_id']}\n"
                    f"üë§ <b>–¢–µ–∫—É—â–∞—è —Ä–æ–ª—å:</b> {updated_user['role']}\n"
                    f"üìÖ <b>–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω:</b> {updated_user['created_at'].strftime('%d.%m.%Y %H:%M')}\n\n"
                    f"–î–ª—è —Å–º–µ–Ω—ã —Ä–æ–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ:"
                )
                keyboard = InlineKeyboardMarkup(inline_keyboard=[
                    [
                        InlineKeyboardButton(
                            text="üîÑ Rolni o'zgartirish" if lang == 'uz' else "üîÑ –ò–∑–º–µ–Ω–∏—Ç—å —Ä–æ–ª—å",
                            callback_data=f"change_role_{updated_user['telegram_id']}"
                        )
                    ]
                ])
                await call.message.edit_text(text, reply_markup=keyboard)
                await call.answer("Rol o'zgartirildi!" if lang == 'uz' else "–†–æ–ª—å –∏–∑–º–µ–Ω–µ–Ω–∞!")
            else:
                text = "Rolni o'zgartirishda xatolik yuz berdi." if lang == 'uz' else "–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–æ–ª–∏."
                await call.message.edit_text(text)
                await call.answer("Xatolik!" if lang == 'uz' else "–û—à–∏–±–∫–∞!")
        except Exception as e:
            logger.error(f"Error in confirm_role_change: {e}", exc_info=True)
            lang = await get_user_lang(call.from_user.id)
            text = "Xatolik yuz berdi." if lang == 'uz' else "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞."
            await call.message.edit_text(text)

    @router.message(AdminUserStates.waiting_for_role_change_id)
    @admin_only
    async def process_role_change_id(message: Message, state: FSMContext):
        lang = await get_user_lang(message.from_user.id)
        try:
            telegram_id = int(message.text.strip())
            user = await get_user_by_telegram_id(telegram_id)
            if not user:
                text = "Foydalanuvchi topilmadi." if lang == 'uz' else "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω."
                await message.answer(text)
                return
            text = (
                f"üë§ <b>Foydalanuvchi:</b> {user.get('full_name', 'N/A')}\n"
                f"üÜî <b>Telegram ID:</b> {user['telegram_id']}\n"
                f"üì± <b>Telefon:</b> {user.get('phone_number', 'N/A')}\n"
                f"üè∑Ô∏è <b>Joriy rol:</b> {user.get('role', 'N/A')}\n\n"
                f"Yangi rolni tanlang:" if lang == 'uz' else
                f"üë§ <b>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</b> {user.get('full_name', 'N/A')}\n"
                f"üÜî <b>Telegram ID:</b> {user['telegram_id']}\n"
                f"üì± <b>–¢–µ–ª–µ—Ñ–æ–Ω:</b> {user.get('phone_number', 'N/A')}\n"
                f"üè∑Ô∏è <b>–¢–µ–∫—É—â–∞—è —Ä–æ–ª—å:</b> {user.get('role', 'N/A')}\n\n"
                f"–í—ã–±–µ—Ä–∏—Ç–µ –Ω–æ–≤—É—é —Ä–æ–ª—å:"
            )
            await message.answer(text, reply_markup=roles_keyboard(user['telegram_id'], lang))
            await state.clear()
        except Exception as e:
            await message.answer("Xatolik yuz berdi." if lang == 'uz' else "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞.")

    @router.message(AdminUserStates.waiting_for_role_change_phone)
    @admin_only
    async def process_role_change_phone(message: Message, state: FSMContext):
        lang = await get_user_lang(message.from_user.id)
        phone = message.text.strip()
        # Search users by phone (partial match allowed)
        from database.base_queries import search_users
        users = await search_users(phone, limit=5)
        if not users:
            await message.answer("Foydalanuvchi topilmadi." if lang == 'uz' else "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω.")
            return
        if len(users) > 1:
            # If multiple users found, show a list
            text = ("Bir nechta foydalanuvchi topildi. Iltimos, aniq telefon raqamini kiriting yoki quyidagilardan tanlang:" if lang == 'uz'
                    else "–ù–∞–π–¥–µ–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É—Ç–æ—á–Ω–∏—Ç–µ –Ω–æ–º–µ—Ä –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑ —Å–ø–∏—Å–∫–∞:")
            keyboard = InlineKeyboardMarkup(inline_keyboard=[
                [InlineKeyboardButton(
                    text=f"{u.get('full_name', 'N/A')} ({u.get('phone_number', 'N/A')})",
                    callback_data=f"change_role_{u['telegram_id']}"
                )] for u in users
            ])
            await message.answer(text, reply_markup=keyboard)
            return
        user = users[0]
        text = (
            f"üë§ <b>Foydalanuvchi:</b> {user.get('full_name', 'N/A')}\n"
            f"üì± <b>Telegram ID:</b> {user['telegram_id']}\n"
            f"üì± <b>Tele—Ñ–æ–Ω:</b> {user.get('phone_number', 'N/A')}\n"
            f"üè∑Ô∏è <b>Joriy rol:</b> {user.get('role', 'N/A')}\n\n"
            f"Yangi rolni tanlang:" if lang == 'uz' else
            f"üë§ <b>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</b> {user.get('full_name', 'N/A')}\n"
            f"üì± <b>Telegram ID:</b> {user['telegram_id']}\n"
            f"üì± <b>–¢–µ–ª–µ—Ñ–æ–Ω:</b> {user.get('phone_number', 'N/A')}\n"
            f"üè∑Ô∏è <b>–¢–µ–∫—É—â–∞—è —Ä–æ–ª—å:</b> {user.get('role', 'N/A')}\n\n"
            f"–í—ã–±–µ—Ä–∏—Ç–µ –Ω–æ–≤—É—é —Ä–æ–ª—å:"
        )
        await message.answer(text, reply_markup=roles_keyboard(user['telegram_id'], lang))
        await state.clear()

    @router.message(F.text.in_(["‚óÄÔ∏è Orqaga", "‚óÄÔ∏è –ù–∞–∑–∞–¥"]))
    @admin_only
    async def back_to_admin_menu(message: Message, state: FSMContext):
        lang = await get_user_lang(message.from_user.id)
        text = "Asosiy admin menyuga qaytdingiz." if lang == 'uz' else "–í—ã –≤–µ—Ä–Ω—É–ª–∏—Å—å –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞."
        await message.answer(text, reply_markup=get_admin_main_menu(lang))
        await state.set_state(AdminMainMenuStates.main_menu)

    @router.message(F.text.in_(["üîÑ Rolni o'zgartirish", "üîÑ –ò–∑–º–µ–Ω–∏—Ç—å —Ä–æ–ª—å"]))
    @admin_only
    async def role_change_menu(message: Message, state: FSMContext):
        lang = await get_user_lang(message.from_user.id)
        text = "Rolni o'zgartirish usulini tanlang:" if lang == 'uz' else "–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± —Å–º–µ–Ω—ã —Ä–æ–ª–∏:"
        await message.answer(text, reply_markup=search_user_method_keyboard(lang))
        await state.set_state(AdminUserStates.waiting_for_search_method)

    @router.callback_query(F.data == "search_by_telegram_id", AdminUserStates.waiting_for_search_method)
    @admin_only
    async def role_change_by_telegram_id(call: CallbackQuery, state: FSMContext):
        lang = await get_user_lang(call.from_user.id)
        text = "Foydalanuvchi Telegram ID sini kiriting:" if lang == 'uz' else "–í–≤–µ–¥–∏—Ç–µ Telegram ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:"
        await call.message.edit_text(text)
        await state.set_state(AdminUserStates.waiting_for_role_change_id)
        await call.answer()

    @router.callback_query(F.data == "search_by_phone", AdminUserStates.waiting_for_search_method)
    @admin_only
    async def role_change_by_phone(call: CallbackQuery, state: FSMContext):
        lang = await get_user_lang(call.from_user.id)
        text = "Foydalanuvchi telefon raqamini kiriting:" if lang == 'uz' else "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:"
        await call.message.edit_text(text)
        await state.set_state(AdminUserStates.waiting_for_role_change_phone)
        await call.answer()

    return router
