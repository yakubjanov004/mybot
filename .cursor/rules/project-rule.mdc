---
description: >
  Telegram CRM bot for Alfa Connect with role-based routing, FSM, multilingual support (uz/ru),
  inline keyboards, modular queries, admin-panel integration, and advanced automation logic.

globs:
  - handlers/**/*.py
  - states/**/*.py
  - database/queries/**/*.py
  - keyboards/**/*.py
  - utils/**/*.py
  - filters/**/*.py
  - main.py
  - loader.py
  - config.py

alwaysApply: true

rules:
  - Use aiogram 3.x idioms, FSMContext, Role-based Routers.
  - Handlers must respect user role via get_role_router("role") and custom middlewares.
  - Localization must use get_user_lang(user_id) and support both "uz" and "ru".
  - Inline keyboards should use callbacks with lang-sensitive text.
  - Database access via modular queries in database/queries/, not raw SQL in handlers.
  - FSM states should be grouped by role under states/ folder.
  - All new feature logic must be language-aware and role-restricted.
  - All routes must clean up inline messages using inline_message_manager utilities.
  - Use consistent naming: e.g., get_admin_orders_router, get_manager_main_menu_router.
  - Comments and docstrings should be in English.
  - Security: never log personal data, use logger filters.
  - All zayavka-related modules should support attachment, status tracking, Telegram alerts, and audit logging.
  - Maintain strict modular structure: handlers/client/, handlers/manager/, etc.
  - New features (AI tools, SLA stats, feedback, PDF export, 1C integration) must be separated in dedicated modules and use `get_role_router()`
---
